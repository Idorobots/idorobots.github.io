<!DOCTYPE html><html><head><meta charset="utf-8" /><title>UPNOD 1: Reverse engineering a vintage TelCo card.</title><link href="../style/bootstrap.min.css" rel="stylesheet" type="text/css" /><link href="../style/font-awesome.min.css" rel="stylesheet" type="text/css" /><link href="../style/ts.theme.dark.css" rel="stylesheet" type="text/css" /><link href="../style/hljs.theme.hybrid.css" rel="stylesheet" type="text/css" /><link href="../style/blog.css" rel="stylesheet" type="text/css" /><link href="../index.xml" rel="alternate" title="UPNOD 1: Reverse engineering a vintage TelCo card. Feed" type /><link href="../media/favicon.ico" rel="icon" type="image/png" /><script src="../js/jquery-2.2.0.min.js" type="text/javascript"></script><script src="../js/jquery.tablesorter.min.js" type="text/javascript"></script><script src="../js/bootstrap.min.js" type="text/javascript"></script><script src="../js/highlight.min.js" type="text/javascript"></script><script src="../js/blog.js" type="text/javascript"></script><meta content="width=device-width, initial-scale=1.0" name="viewport" /><meta content="λ-blog v.1.3.3" name="generator" /><meta content="Idorobots" name="author" /><meta content="Kajetan Rzepecki, Idorobots, dev-blog, devblog, blog, Clojure, Lisp, Erlang, technology, electronics, hacks, computer science" name="keywords" /><meta content="Yes Mom, I *do* robots." name="description" /></head><body><nav class="navbar navbar-default navbar-fixed-top"><div class="container"><div class="navbar-header"><button class="navbar-toggle navbar-brand pull-left" data-target="#navbar-responsive-collapse" data-toggle="collapse" type="button"><div><img src="../media/logo.svg" />idorobots.org</div></button><div class="hidden-xs"><a class="navbar-brand" href=".."><div><img src="../media/logo.svg" />idorobots.org</div></a></div></div><div class="collapse navbar-collapse navbar-right" id="navbar-responsive-collapse"><ul class="nav navbar-nav"><li><a href="https://keybase.io/kajtek/"><i class="fa fa-user"> Keybase</i></a></li><li><a href="https://github.com/Idorobots"><i class="fa fa-github"></i> GitHub</a></li><li><a href="../resume.html"><i class="fa fa-trophy"></i> Resumé</a></li><li><a href="../contact.html"><i class="fa fa-comment"></i> Contact</a></li><li class="divider hidden-sm hidden-md hidden-lg"></li><li class="hidden-sm hidden-md hidden-lg"><a href=".."><i class="fa fa-home"></i> Home</a></li><li class="hidden-sm hidden-md hidden-lg"><a href="../archives.html"><i class="fa fa-archive"></i> Archives</a></li><li class="hidden-sm hidden-md hidden-lg"><a href="../tags/index.html"><i class="fa fa-tags"></i> Tag Cloud</a></li><li class="hidden-sm hidden-md hidden-lg"><a href="../index.xml"><i class="fa fa-feed"></i> Feed</a></li><li class="dropdown hidden-xs"><a href="#"><i class="fa fa-chevron-right"></i></a><ul class="dropdown-menu"><li><a href=".."><i class="fa fa-home"></i> Home</a></li><li><a href="../archives.html"><i class="fa fa-archive"></i> Archives</a></li><li><a href="../tags/index.html"><i class="fa fa-tags"></i> Tag Cloud</a></li><li><a href="../index.xml"><i class="fa fa-feed"></i> Feed</a></li></ul></li></ul></div></div></nav><div class="body-wrap"><article id="page"><div class="container"><header class="page-header"></header><article><header><div class="panel panel-default"><div class="panel-body"><div class="text-center"><h1>UPNOD 1: Reverse engineering a vintage TelCo card.</h1><p>Posted on <time>2016-03-02 02:36</time> by <a href="https://github.com/Idorobots">Idorobots</a></p><nav><a class="tag" href="../tags/upnod.html"><span class="label label-info small">UPNOD</span></a> <a class="tag" href="../tags/z80.html"><span class="label label-info small">Z80</span></a> <a class="tag" href="../tags/electronics.html"><span class="label label-info small">electronics</span></a> <a class="tag" href="../tags/reverse-engineering.html"><span class="label label-info small">reverse engineering</span></a> <a class="tag" href="../tags/vintage-electronics.html"><span class="label label-info small">vintage electronics</span></a></nav></div></div></div></header><p>Since my last actual post on this blog I have acquired a new <em>class of hobbies</em> - electronics. Most recently, reverse engineering of really old computers. This series of posts will be about a vintage eighties TelCo computer-card-thing marked <strong>UPNOD CARD0117 TN64</strong> I bought on a local auction:</p><p><img src="https://blog.idorobots.org/media/upnod1/top.JPG" alt="top" /></p><p>All my findings will be posted on this blog and the accompanying data will be gathered in <a href='https://github.com/Idorobots/upnod-card0117-tn64'>this GitHub repository</a>. <a name="preview-more"></a></p><p>From what I was told, the card came from an old internal telephony system of the <a href='http://www.mech.pk.edu.pl/'>Mechanics Department</a> of the <a href='https://en.wikipedia.org/wiki/Tadeusz_Ko%C5%9Bciuszko_University_of_Technology'>Tadeusz Kościuszko University of Technology</a>. More precisely, it was one of the backup boards for said system and the guy insisted it was in mint condition and hasn't been used (not quite true, more on that <a href='#board'>below</a>). <em>They</em> apparently modernized <em>their</em> internal systems (about damn time if you ask me) and trashed whole racks of similar electronics saving only this one card, because it <em>was clean</em>.</p><p><a href='https://www.youtube.com/watch?v=orcvOtbTCjE'>This saddened me greatly...</a></p><h2><a name="board"></a><a href="#board">Board</a></h2><p>The card uses an SGS-made <em><a href='https://en.wikipedia.org/wiki/Zilog_Z80'>Z80</a></em> microprocessor, an SGS-made <em>Z8430</em> programmable timer chip, whoppin' <em>64 KB</em> of <a href='http://www.datasheetlib.com/datasheet/732265/hm4864p-2_hitachi-semiconductor.html'>dynamic RAM</a>, 16 KB of ROM and a bunch of electronics voodoo all over the place. It almost resembles a generic Z80-based microcomputer if not for the discrete implementation of IO devices next to the <a href='https://en.wikipedia.org/wiki/DIN_41612'>DIN41612</a> connectors (more on that later in the series). The board has two layers, with single-sided load and appears to have been auto-routed. There are multiple test point headers on the board making it easier to test it if I ever run it and find a way to make it do anything. It's marked <strong>TN64</strong> on the PCB and <strong>TN104</strong> on one of the connectors - I assume TN64 is the PCB layout, and the actual model number is determined by both the layout and the loaded <a href='#software'>software</a>.</p><p>What's pretty neat about this board is the abundance of blue mod-wires - the board has been upgraded at least once in the past (so it can't be "new old stock" as the guy I bought it form has claimed), possibly twice or upgraded once and then scavenged for parts later (there's one 10-pin SIP package desoldered, one 8-pin DIP package missing & one RAM stand badly damaged). All the reverse-engineered schematics you'll find in this series & in the <a href='https://github.com/Idorobots/upnod-card0117-tn64'>GitHub repository</a> will follow both the original layout (<strong>TN104</strong>) and the modded one (marked <strong>TN135</strong> with a faint marker).</p><h2><a name="software"></a><a href="#software">Software</a></h2><p>There are two 8 KB EPROMs on the board - the top one marked <strong>v2196</strong> and the bottom one marked <strong>ONT0 RIB (0:1)</strong>. The bottom ROM is dedicated to program memory only while the top one contains all kinds of UI strings in what appears to be Norwegian:</p><p><div class="row"><div class="col-xs-12 col-md-8 col-md-offset-2 col-lg-6 col-lg-offset-3"></p><pre><code class="clojure-repl">&lt; NDH - UPNOD TCS-2000 terminal-veksler &gt;
&lt; Velg datamaskin/system ?  &#40; ? gir hjelp &#41; &gt;
&lt; Datamaskin/system ? &gt;
&lt; Forbindelsen nedkoblet &gt;
LOG OG UD
&lt; Alle porter med |nsket hastighet er opptatt &gt;
&lt; Feil valg, ? gir hjelp &gt;
&lt; Ikke tillat valg, ? gir hjelp &gt;
&lt; Valgmulighet:
    N,A = ND500.182
    D,A = Discovery System A  &#40;DSA&#41;
    ...............................
 \nsker de ytterligere hjelp,skriv H &gt;
Kontroll-sekvenser i Upnod TCS 2000:
  1. N}r datamaskin velges:
     -Tastes &lt;CTRL+C&gt; f|r &lt;CR&gt; vil brukeren f} tildelt en
      datamaskinport med lavere hastighet enn terminalens.
      Denne mulighet kan brukes n}r alle datamaskinporter
      med |nsket hastighet er opptatt
     -Tastes &lt;CTRL+D&gt; f|r &lt;CR&gt; sl}s lokalekko av.
     -Tastes &lt;CTRL+E&gt; f|r CR sl}s lokalekko p}.
     -Tastes &lt;ESC&gt; istedet for &lt;CR&gt; sl}r du
      p} XON/XOFF flytkontroll
  2. N}r du er oppkoplet
     -Tastes &lt;BREAK&gt; etterfulgt av &lt;CTRL+X&gt; kan en av
      f|lgende kommandoer benyttes:
      &lt;CTRL+A&gt;: sl}r p} XON/XOFF flytkontroll.
      &lt;CTRL+B&gt;: sl}r av XON/XOFF flytkontroll.
      &lt;CTRL+D&gt;: sl}r av lokalekko.
      &lt;CTRL+D&gt;: sl}r p} lokalekko.
      &lt;CTRL+F&gt;: medf|rer at UPNOD TCS-2000 kopler ned
      linjen mot datamaskinen. NB!! Du kan fortsatt v{re
      logget inn p} datamaskinen.
</code></pre><p></div></div></p><p>There are also some English strings present:</p><p><div class="row"><div class="col-xs-12 col-md-8 col-md-offset-2 col-lg-6 col-lg-offset-3"></p><pre><code class="clojure-repl">&#42;&#42;&#42; Illegal command
&#42;&#42;&#42; Not computerport
&#42;&#42;&#42; Nonexist. group
&#42;&#42;&#42; Illegal priority
&#42;&#42;&#42; Not local port
&#42;&#42;&#42; No ports
&#42;&#42;&#42; Port connected
, Remote comm
&#42;&#42;&#42; Invalid porttype &#42;&#42;&#42;
&#42;&#42;&#42; Not connected &#42;&#42;&#42;
Computer:
&#42;&#42;&#42; Illegal address
&#42;&#42;&#42; No free buffers
&#42;&#42;&#42; No message
&#42;&#42;&#42;&#42; Port connected &#42;&#42;&#42;
</code></pre><p></div></div></p><p>Some of them are quite amusing:</p><p><div class="row"><div class="col-xs-12 col-md-8 col-md-offset-2 col-lg-6 col-lg-offset-3"></p><pre><code class="clojure-repl">Illegal error
THE QUICK BROWN BOX JUMPS OVER THE LAZY FROG
</code></pre><p></div></div></p><p>Yeah, you don't want to get an <strong>Illegal error</strong>, do you?</p><p>Judging by the contents of the ROMs and by what the guy I bought this card from said, I can quite confidently say that this card was a Norwegian TelCo <em>terminal controller</em> for some remote devices. It allowed the operator to open new ports and map them to internal RAM buffers (more on that in a later post) and in general was a pretty complicated machine for 16KB of program memory & 64KB of RAM.</p><h2><a name="enough-of-the-words_-let_s-see-some-reverse-engineering_"></a><a href="#enough-of-the-words_-let_s-see-some-reverse-engineering_">Enough of the words, let's see some reverse-engineering!</a></h2><p>Starting with the clock circuit roughly located here on the board:</p><p><div class="row"><div class="col-xs-12 col-md-8 col-md-offset-2"></p><p><img src="https://blog.idorobots.org/media/upnod1/clock.png" alt="clock" /></p><p></div></div></p><p>...which translates to:</p><p><div class="row"><div class="col-xs-12 col-md-8 col-md-offset-2"></p><p><img src="https://blog.idorobots.org/media/upnod1/clock-sch.png" alt="clock-scm" /></p><p></div></div></p><p>The 16 MHz oscillator signal (magenta) is divided by 4 (blue) to obtain the <em>main CLK</em> frequency of 4 MHz which is later inverted (green). The weird thing is, that the clock circuit's components are mostly located right next to the oscillator & the microprocessor except for one of the inverters which has been placed all the way on the other side of the board with the clock signal traveling all the way there and back with lot's of space for interference. Also, there's a curious pass transistor circuit (red) across one of the inverters going to the Z80 and the CTC. Based on its placement and the RC network at its base I speculate it's there either for <a href='https://en.wikipedia.org/wiki/Waveform_shaping'>waveform shaping</a> or to give some extra current handling capability to the inverter feeding Z80 CLK pin. Or both. It's pretty baffling, though.</p><p><div class="text-center"></p><p>¯&#92;&#95;(ツ)&#95;/¯</p><p></div></p><p>After some <em>hand-wavey</em> simulations using the <a href='http://www.falstad.com/circuit/'>Falstad circuit simulator</a> the waveform shaping hypothesis seems plausible. After taking inverter output capacitance & impedance into account (disregard the ridiculous 10 uF value, it's there to compensate for low frequency of the simulated clock signal) and fiddling with RC circuits parameters I came up with this:</p><p><div class="row"><div class="col-xs-12 col-md-8 col-md-offset-2"></p><p><img src="https://blog.idorobots.org/media/upnod1/sim.png" alt="sim" /></p><p></div></div></p><p>The initial four cycles were captured with the pass transistor switched out of the circuit. As can be expected, the waveform is far from a perfect square wave and may cause trouble when applied as the clock signal. When the pass transistor is enabled however, the initial rising edge is far sharper as exhibited by the last three cycles of the simulated waveform. Sounds reasonable enough for the girls I go out with and according to <a href='http://home.mit.bme.hu/~benes/oktatas/dig-jegyz_052/Z80-kivonat.pdf'>some sources</a>:</p><blockquote><p> The CPU samples the data from the memory on the data bus with the rising edge of the clock of state T3 and this same edge is used by the CPU to turn off the /RD and /MREQ signals. </p></blockquote><p>Other than that, the 4 MHz clock signal as well as the unmodified 16 MHz oscillator signal go off to the RAM circuit and the <a href='https://en.wikipedia.org/wiki/Parallel_ATA'>PATA-style</a> connector next to the ROMs I dubbed <em>North</em>.</p><p>More reverse-engineering shenanigans to come...</p><p><strong>2016-03-02</strong>: Updated clock circuit placement diagram & description. <strong>2016-03-08</strong>: Updated clock circuit schematic & placement diagram.</p><footer><div class="row"><div class="hidden-xs col-md-2"></div><div class="col-xs-6 col-md-4"><nav><ul class="pager"><li class="previous"><a href="../entries/blog-reboot_.html"><i class="fa fa-chevron-left" style="margin-right: 5px;"></i><span class="entry-title">Blog reboot!</span></a></li></ul></nav></div><div class="col-xs-6 col-md-4"><nav><ul class="pager"><li class="next"><a href="../entries/atari-xe-multicart.html"><span class="entry-title">Atari XE Multicart</span><i class="fa fa-chevron-right" style="margin-left: 5px;"></i></a></li></ul></nav></div></div></footer></article><footer><hr /><div class="row"><div class="text-center"><div class="row"><div>Copyright © 2011-2018 Kajetan "Kajtek" Rzepecki</div><div>All writing licensed under <a href="http://creativecommons.org/licenses/by-sa/4.0/" rel="license">CC BY-SA 4.0</a>. All code released under the <a href="../media/LICENSE" rel="license">MIT license</a> unless otherwise specified.</div></div></div><div class="text-center"><p>Powered by <a href="https://github.com/Idorobots/lambda-blog">λ-blog</a>.</p></div></div></footer></div></article></div></body></html>