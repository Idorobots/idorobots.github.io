<!DOCTYPE html><html><head><meta charset="utf-8" /><title>Atari XE Multicart</title><link href="../style/bootstrap.min.css" rel="stylesheet" type="text/css" /><link href="../style/font-awesome.min.css" rel="stylesheet" type="text/css" /><link href="../style/ts.theme.dark.css" rel="stylesheet" type="text/css" /><link href="../style/hljs.theme.hybrid.css" rel="stylesheet" type="text/css" /><link href="../style/blog.css" rel="stylesheet" type="text/css" /><link href="../index.xml" rel="alternate" title="Atari XE Multicart Feed" type /><link href="../media/favicon.ico" rel="icon" type="image/png" /><script src="../js/jquery-2.2.0.min.js" type="text/javascript"></script><script src="../js/jquery.tablesorter.min.js" type="text/javascript"></script><script src="../js/bootstrap.min.js" type="text/javascript"></script><script src="../js/highlight.min.js" type="text/javascript"></script><script src="../js/blog.js" type="text/javascript"></script><meta content="width=device-width, initial-scale=1.0" name="viewport" /><meta content="λ-blog v.1.3.3" name="generator" /><meta content="Idorobots" name="author" /><meta content="Kajetan Rzepecki, Idorobots, dev-blog, devblog, blog, Clojure, Lisp, Erlang, technology, electronics, hacks, computer science" name="keywords" /><meta content="Yes Mom, I *do* robots." name="description" /></head><body><nav class="navbar navbar-default navbar-fixed-top"><div class="container"><div class="navbar-header"><button class="navbar-toggle navbar-brand pull-left" data-target="#navbar-responsive-collapse" data-toggle="collapse" type="button"><div><img src="../media/logo.svg" />idorobots.org</div></button><div class="hidden-xs"><a class="navbar-brand" href=".."><div><img src="../media/logo.svg" />idorobots.org</div></a></div></div><div class="collapse navbar-collapse navbar-right" id="navbar-responsive-collapse"><ul class="nav navbar-nav"><li><a href="https://keybase.io/kajtek/"><i class="fa fa-user"> Keybase</i></a></li><li><a href="https://github.com/Idorobots"><i class="fa fa-github"></i> GitHub</a></li><li><a href="../resume.html"><i class="fa fa-trophy"></i> Resumé</a></li><li><a href="../contact.html"><i class="fa fa-comment"></i> Contact</a></li><li class="divider hidden-sm hidden-md hidden-lg"></li><li class="hidden-sm hidden-md hidden-lg"><a href=".."><i class="fa fa-home"></i> Home</a></li><li class="hidden-sm hidden-md hidden-lg"><a href="../archives.html"><i class="fa fa-archive"></i> Archives</a></li><li class="hidden-sm hidden-md hidden-lg"><a href="../tags/index.html"><i class="fa fa-tags"></i> Tag Cloud</a></li><li class="hidden-sm hidden-md hidden-lg"><a href="../index.xml"><i class="fa fa-feed"></i> Feed</a></li><li class="dropdown hidden-xs"><a href="#"><i class="fa fa-chevron-right"></i></a><ul class="dropdown-menu"><li><a href=".."><i class="fa fa-home"></i> Home</a></li><li><a href="../archives.html"><i class="fa fa-archive"></i> Archives</a></li><li><a href="../tags/index.html"><i class="fa fa-tags"></i> Tag Cloud</a></li><li><a href="../index.xml"><i class="fa fa-feed"></i> Feed</a></li></ul></li></ul></div></div></nav><div class="body-wrap"><article id="page"><div class="container"><header class="page-header"></header><article><header><div class="panel panel-default"><div class="panel-body"><div class="text-center"><h1>Atari XE Multicart</h1><p>Posted on <time>2016-04-24 11:05</time> by <a href="https://github.com/Idorobots">Idorobots</a></p><nav><a class="tag" href="../tags/6502.html"><span class="label label-info small">6502</span></a> <a class="tag" href="../tags/atari.html"><span class="label label-info small">Atari</span></a> <a class="tag" href="../tags/c.html"><span class="label label-info small">C</span></a> <a class="tag" href="../tags/cc65.html"><span class="label label-info small">CC65</span></a> <a class="tag" href="../tags/eagle-cad.html"><span class="label label-info small">Eagle CAD</span></a> <a class="tag" href="../tags/oshw.html"><span class="label label-info small">OSHW</span></a> <a class="tag" href="../tags/electronics.html"><span class="label label-info small">electronics</span></a> <a class="tag" href="../tags/hacks.html"><span class="label label-info small">hacks</span></a> <a class="tag" href="../tags/hardware.html"><span class="label label-info small">hardware</span></a></nav></div></div></div></header><p>Cranking out another post took me way longer than I had anticipated when I rebooted this blog, but I got sidetracked by another <em>quick</em> <a href='https://github.com/Idorobots/atari-xe-multicart'>hardware project</a> that turned out to be way more involved and equally more fun than I originally thought...</p><p><img src="https://blog.idorobots.org/media/multicart/multicart.png" alt="multicart" /></p><p>I've designed an Atari 400/800/XL/XE standard cartridge compatible board that can hold up to 127 different standard 8KB and 16KB game ROMs at the same time. It's memory chip agnostic and features software game selection & a few neat hacks. <a name="preview-more"></a><h2><a name="the-hardware"></a><a href="#the-hardware">The hardware</a></h2></p><p>The PCB design went through several iteration and that's part of the reason why this little project took so much time - the initial version supported only 8KB game ROMs, while the latest version supports both standard cartridge types, a plethora of different memory chips and fits neatly in a <a href='http://www.tme.eu/pl/details/z-7/obudowy-z-panelem/kradex/z7/'>Z7 case</a>, which apparently is still produced here in Poland. Here's a schematic:</p><p><img src="https://blog.idorobots.org/media/multicart/schematic.png" alt="schematic" /></p><p>The <code>74HTC373</code> latch is used as register that can be written to by accessing the Cartridge Control Block within the Atari causing the <code>CCTL</code> line to go low and in turn latch <code>EN</code>able line to go high. Storing a value there causes a toggle of some of the address lines going to the main memory chip and, if applicable, the <code>RD4</code> line telling the Atari that a 16KB ROM is present. A special care was needed to support 16KB ROMs - the <code>A12</code> address line of the memory chip is the result of <code>OR</code>'ing one of the latch outputs and the <code>S4</code> (low memory slot selection) line. This is done by the <code>74HTC08</code> quad-<code>AND</code> gate, as both of these lines are negated. The <code>S4</code> line, which is used only for 16KB ROMs, basically overrides the <code>A12</code> address line taking precedence over the latch output, which is OK, since 16KB ROMs occupy both memory slots and shouldn't be using that output anyway. It's worth to mention, that it is mandatory to align 16KB ROMs in the memory chip to a 16KB boundary (<code>A12</code> equal to <code>0</code>) so both 8KB halves of the ROM are mapped to the correct memory slots in the Atari address space. The main memory chip footprint is configured so that any JEDEC compatible EEPROM/Flash can be used ranging from <code>27C64</code> compatibles up to <code>27C080</code>, which can hold a whoopin' <strong>1MB</strong> of classic Atari games.</p><p>The design is deceptively similar to a <a href='http://www.atarimax.com/jindroush.atari.org/acarts.html'>XEGS cartridge</a> in that it uses a <code>74HTC373</code> latch and some glue logic, but in terms of functionality it's far from it. For starters, <em>XE Multicart</em> only supports standard ROMs which it selectively maps to the cartridge slots of the Atari memory space. Furthermore, it switches both cartridge memory slots on and off when appropriate, while XEGS cartridges always map the last ROM bank to the second slot. Basically, <em>XE Multicart</em> emulates standard 8KB and 16KB cartridges with a single shot, software game selection. No other cartridge types are supported at the moment.</p><p>For the next iteration, I might want to get rid of the <code>74HTC08</code> chip, as only half of it is used by the design. Both of these <code>AND</code> gates could be implemented with MOSFETs, just like the inverter on the <code>CCTL</code> line:</p><p><img src="https://blog.idorobots.org/media/multicart/gates.png" alt="gates" /></p><h2><a name="the-software"></a><a href="#the-software">The software</a></h2><p>The software is very simple - it only presents a list of available games and processes user input to make the selection:</p><p><img src="https://blog.idorobots.org/media/multicart/menu.png" alt="menu" /></p><p>Once a suitable selection is made, a value matching it is written to the Cartridge Control Block (<code>CCTL</code>), which is mapped to the <code>74HTC373</code> latch described above, causing a game bank switch in the memory chip. This bank switch causes a problem, however. The very game selection code that is being executed by the console is being swapped out in favor of a game ROM before we actually jump into it. The rather obvious thing to do is to store all the needed code elsewhere, so we don't loose any of it during the switch. The software just needs to back itself up to a known empty place in RAM, perform a cleanup and then jump its way back to the stored copy... Somehow...</p><p>Cue the hacks!</p><p><div class="row"><div class="col-xs-12 col-md-8 col-md-offset-2 col-lg-6 col-lg-offset-3"></p><pre><code class="c">#define CCTL &#40;&#40;unsigned char &#42;&#41; 0xD500&#41;
#define DOSVEC &#40;&#40;unsigned int &#42;&#41; 0x0A&#41;
#define RESET 0xFFFC

#define BOOTSTRAP&#95;SIZE 0x400
#define BOOTSTRAP&#95;AREA &#40;0x8000 - BOOTSTRAP&#95;SIZE&#41;

unsigned char selection&#95;mask;
unsigned int DOSVEC&#95;save;

int main&#40;void&#41; {
  // ...

  selection&#95;mask = ...;

  // Backup bootstrap&#40;&#41; into the RAM not to loose it later.
  memcpy&#40;&#40;void &#42;&#41; BOOTSTRAP&#95;AREA, &#40;const void &#42;&#41; bootstrap, BOOTSTRAP&#95;SIZE&#41;;

  // Spoof the return address so we jump back into bootstrap&#40;&#41;.
  DOSVEC&#95;save = &#42;DOSVEC;
  &#42;DOSVEC = BOOTSTRAP&#95;AREA;

  // Do the cleanup.
  exit&#40;1&#41;;
}

void &#95;&#95;fastcall&#95;&#95; bootstrap&#40;void&#41; {
  // Restore the DOS vector.
  &#42;DOSVEC = DOSVEC&#95;save;

  // Swap the game.
  &#42;CCTL = selection&#95;mask;

  // Reset the console.
  &#95;&#95;asm&#95;&#95; &#40;&quot;jmp &#40;%w&#41;&quot;, RESET&#41;;
}
</code></pre><p></div></div></p><p>That's precisely what I did - a little bootstrap code is straight up <code>memcpy</code>'ied into another location with no regard for position dependence whatsoever. Crude but effective. Once that has been done, the OS return address (<code>DOSVEC</code>) is backed up and overwritten to point to the newly copied bootstrap code and the CC65 runtime is cleaned up simply by invoking <code>exit&#40;&#41;</code>. After that, the runtime jumps into our spoofed <code>DOSVEC</code> and the bank switch is performed along a console reset, which starts the game.</p><p>Unfortunately, this isn't enough as a so-called <strong>warm-reset</strong> is executed - the OS doesn't perform most of the setup that it normally does, only the bare minimum - and that, coupled with how CC65 runtime works, messes some games up. Fortunately enough, a hackaround for this is rather simple - just mess up the OS sanity checks by faking broken RAM where appropriate:</p><p><div class="row"><div class="col-xs-12 col-md-8 col-md-offset-2 col-lg-6 col-lg-offset-3"></p><pre><code class="c">#define SANITYCHECK &#40;&#40;unsigned char &#42;&#41; 0x33D&#41;

int main&#40;void&#41; {
  &#42;SANITYCHECK = 0x23; // Ensure cold-start is performed during reset.

  // ...
}
</code></pre><p></div></div> <div class="text-center"></p><p>¯&#92;&#95;(ツ)&#95;/¯</p><p></div></p><footer><div class="row"><div class="hidden-xs col-md-2"></div><div class="col-xs-6 col-md-4"><nav><ul class="pager"><li class="previous"><a href="../entries/upnod-1_-reverse-engineering-a-vintage-telco-card..html"><i class="fa fa-chevron-left" style="margin-right: 5px;"></i><span class="entry-title">UPNOD 1: Reverse engineering a vintage TelCo card.</span></a></li></ul></nav></div><div class="col-xs-6 col-md-4"><nav><ul class="pager"><li class="next"><a href="../entries/upnod-2_-the-reset-circuit..html"><span class="entry-title">UPNOD 2: The reset circuit.</span><i class="fa fa-chevron-right" style="margin-left: 5px;"></i></a></li></ul></nav></div></div></footer></article><footer><hr /><div class="row"><div class="text-center"><div class="row"><div>Copyright © 2011-2021 Kajetan "Kajtek" Rzepecki</div><div>All writing licensed under <a href="http://creativecommons.org/licenses/by-sa/4.0/" rel="license">CC BY-SA 4.0</a>. All code released under the <a href="../media/LICENSE" rel="license">MIT license</a> unless otherwise specified.</div></div></div><div class="text-center"><p>Powered by <a href="https://github.com/Idorobots/lambda-blog">λ-blog</a>.</p></div></div></footer></div></article></div></body></html>