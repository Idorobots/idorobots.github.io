<!DOCTYPE html><html><head><meta charset="utf-8" /><title>ASM development log 3: DSLs</title><link href="../style/bootstrap.min.css" rel="stylesheet" type="text/css" /><link href="../style/font-awesome.min.css" rel="stylesheet" type="text/css" /><link href="../style/ts.theme.dark.css" rel="stylesheet" type="text/css" /><link href="../style/hljs.theme.hybrid.css" rel="stylesheet" type="text/css" /><link href="../style/blog.css" rel="stylesheet" type="text/css" /><link href="../index.xml" rel="alternate" title="ASM development log 3: DSLs Feed" type /><link href="../media/favicon.ico" rel="icon" type="image/png" /><script src="../js/jquery-2.2.0.min.js" type="text/javascript"></script><script src="../js/jquery.tablesorter.min.js" type="text/javascript"></script><script src="../js/bootstrap.min.js" type="text/javascript"></script><script src="../js/highlight.min.js" type="text/javascript"></script><script src="../js/blog.js" type="text/javascript"></script><meta content="width=device-width, initial-scale=1.0" name="viewport" /><meta content="λ-blog v.1.3.0" name="generator" /><meta content="Idorobots" name="author" /><meta content="Kajetan Rzepecki, Idorobots, dev-blog, devblog, blog, Clojure, Lisp, Erlang, technology, electronics, hacks, computer science" name="keywords" /><meta content="Yes Mom, I *do* robots." name="description" /></head><body><nav class="navbar navbar-default navbar-fixed-top"><div class="container"><div class="navbar-header"><button class="navbar-toggle navbar-brand pull-left" data-target="#navbar-responsive-collapse" data-toggle="collapse" type="button"><div><img src="../media/logo.svg" />idorobots.org</div></button><div class="hidden-xs"><a class="navbar-brand" href=".."><div><img src="../media/logo.svg" />idorobots.org</div></a></div></div><div class="collapse navbar-collapse navbar-right" id="navbar-responsive-collapse"><ul class="nav navbar-nav"><li><a href="https://github.com/Idorobots"><i class="fa fa-github"></i> GitHub</a></li><li><a href="../resume.html"><i class="fa fa-trophy"></i> Resumé</a></li><li><a href="../contact.html"><i class="fa fa-comment"></i> Contact</a></li><li class="divider hidden-sm hidden-md hidden-lg"></li><li class="hidden-sm hidden-md hidden-lg"><a href=".."><i class="fa fa-home"></i> Home</a></li><li class="hidden-sm hidden-md hidden-lg"><a href="../archives.html"><i class="fa fa-archive"></i> Archives</a></li><li class="hidden-sm hidden-md hidden-lg"><a href="../tags/index.html"><i class="fa fa-tags"></i> Tag Cloud</a></li><li class="hidden-sm hidden-md hidden-lg"><a href="../index.xml"><i class="fa fa-feed"></i> Feed</a></li><li class="dropdown hidden-xs"><a href="#"><i class="fa fa-chevron-right"></i></a><ul class="dropdown-menu"><li><a href=".."><i class="fa fa-home"></i> Home</a></li><li><a href="../archives.html"><i class="fa fa-archive"></i> Archives</a></li><li><a href="../tags/index.html"><i class="fa fa-tags"></i> Tag Cloud</a></li><li><a href="../index.xml"><i class="fa fa-feed"></i> Feed</a></li></ul></li></ul></div></div></nav><div class="body-wrap"><article id="page"><div class="container"><header class="page-header"></header><article><header><div class="panel panel-default"><div class="panel-body"><div class="text-center"><h1>ASM development log 3: DSLs</h1><p>Posted on <time>2012-08-17 12:03</time> by <a href="https://github.com/Idorobots">Idorobots</a></p><nav><a class="tag" href="../tags/asm.html"><span class="label label-info small">ASM</span></a> <a class="tag" href="../tags/dsl.html"><span class="label label-info small">DSL</span></a> <a class="tag" href="../tags/json.html"><span class="label label-info small">JSON</span></a> <a class="tag" href="../tags/lisp.html"><span class="label label-info small">Lisp</span></a> <a class="tag" href="../tags/grammars.html"><span class="label label-info small">grammars</span></a> <a class="tag" href="../tags/parsers.html"><span class="label label-info small">parsers</span></a></nav></div></div></div></header><p>"<em>Kajtek, you incredibly handsome stallion, what have you been doing these past few months?</em>" - <a href='http://i37.tinypic.com/ncjqk2.jpg'>you might ask</a>, concerned about the lack of ASM dev logs recently...</p><p>Well, I've mostly been studying various <a href='http://en.wikipedia.org/wiki/Programming_language#Design_and_implementation'>PL design</a> quirks and prototyping neat features such as <a href='http://lambda-the-ultimate.org/node/4093'>vau calculus</a> flavoured <a href='http://en.wikipedia.org/wiki/Fexpr'>fexprs</a> or the following piece of what I consider <a href='http://cache.ohinternet.com/images/thumb/2/2d/Trollface_HD.png/618px-Trollface_HD.png'>art</a>.</p><p>As mentioned <a href='http://blog.idorobots.org/entries/asm-development-log-2_-dilly-dallying.html'>before</a>, I was working on an extensible reader that would support user-defined reader macros for easy <a href='http://en.wikipedia.org/wiki/Domain-specific_language'>DSL</a> programming. It took me quite some time, effort and researching but eventually I came up with an awesome solution. It's worthy to mention here, that it's in no way a <a href='http://tinlizzie.org/ometa/'>new solution</a>. I prefer to figure stuff out myself and often times it turns out that similar concept already existed a few years before mine. <a href='http://www.aerialnoise.com/wp-content/uploads/2012/07/Endless-Bummer-400x400.jpg'>Bummer</a> <code>u&#95;u</code>. <a name="preview-more"></a><h2><a name="peg-reader-generator"></a><a href="#peg-reader-generator">PEG reader generator</a></h2>The idea is simple - modify the syntax of the <a href='https://github.com/Idorobots/asm'>hosting language</a> using full capabilities of said language extending its functionality on the fly. As simple as it may sound it's not simple at all.</p><p>Most common parsing techniques such as using <a href='http://en.wikipedia.org/wiki/Context-free_grammar'>CFG</a> and <a href='http://en.wikipedia.org/wiki/LL_parser'>LL(k)</a> or <a href='http://en.wikipedia.org/wiki/LR_parser'>LR(k)</a> parsers are not particularly well-suited for this task, because they require a separate phase of lexical analysis which, while sounding innocently, complicated the design of the reader sufficiently enough for me to drop the idea for several weeks. Long story short, I started looking for something different but equally powerful, such as <a href='http://en.wikipedia.org/wiki/Hygienic_macro'>hygienic macros</a> or fexprs with further improvements, and eventually stumbled upon <a href='http://en.wikipedia.org/wiki/Parsing_expression_grammar'>this</a>.</p><p><strong>PEG</strong> is a scannerless parsing technique designed as an alternative to CFG's. PEG's are expressive and <a href='http://bford.info/pub/lang/packrat-icfp02/'>packrat</a> parsers generated for PEG's work in guaranteed linear time thanks to memoization, but what's most important - packrat parsers are dead <strong>simple to generate</strong>.</p><p>My second experimental (but most likely final) reader design is based on PEG parser generation - given a set of grammar rules and (optional) code transformations it generates immensely recursive (but not yet memoized) parser that can be easily extended with new rules thanks to (but not necessarily requiring) <a href='http://en.wikipedia.org/wiki/Late_binding'>late binding</a>.</p><p>Here's an example, which you can try out yourself by importing <code>experimental.parser2</code>:</p><p><div class="row"><div class="col-xs-12 col-md-8 col-md-offset-2 col-lg-6 col-lg-offset-3"></p><pre><code class="scheme">&#40;grammar &#40;&#40;Expression &lt; &#40;/ String List Atom&#41;&#41;&#41;
         &#40;&#40;String     &lt;- &#40;:&quot;\&quot;&quot;&#41; &quot;&#91;&#94;\&quot;&#93;&#42;&quot; &#40;: &quot;\&quot;&quot;&#41;&#41;&#41;
         &#40;&#40;List       &lt; &#40;: &quot;\\​&#40;&quot;&#41; &#40;&#42; Expression&#41; &#40;: &quot;\\&#41;&quot;&#41;&#41;
                        `&#40;$&#40;car List&#41;
                          $&#40;cdr List&#41;&#41;&#41;
         &#40;&#40;Atom       &lt;- &#40;/ Number Symbol&#41;&#41;&#41;
         &#40;&#40;Number     &lt;- &quot;&#91;+\\-&#93;?&#91;0-9&#93;+&#40;\\.&#91;0-9&#93;&#42;&#41;?&quot;&#41;
                         `&#40;$&#40;car Number&#41;
                           &#40;$&#40;str-&gt;num &#40;caadr Number&#41;&#41;&#41;&#41;&#41;
         &#40;&#40;Symbol     &lt;- &#40;! Number&#41; &quot;&#91;&#94;\\​&#40;\\&#41;\&quot;';\\s&#93;+&quot;&#41;
                         `&#40;$&#40;car Symbol&#41;
                           &#40;$&#40;str-&gt;symbol &#40;caadr Symbol&#41;&#41;&#41;&#41;&#41;
         &#40;&#40;Spacing    &lt;- &#40;&#42; &#40;/ Comment &quot;&#91;\\s&#93;+&quot;&#41;&#41;&#41;&#41;
         &#40;&#40;Comment    &lt;- &#40;: &quot;;&quot; &quot;&#91;&#94;\n&#93;&#42;\n&quot;&#41;&#41;&#41;&#41;

&#40;Expression &quot;&#40;define &#40;compose f g&#41;
               &#40;lambda &#40;arg&#41; &#40;f &#40;g arg&#41;&#41;&#41;&#41;&quot;&#41;
</code></pre><p></div></div></p><p>Few things to notice about this simple Lisp grammar definition:</p><ul><li>It's very succinct and it mostly resembles a formal grammar definition of Lisp.</li><li>It uses quasiquotation and other hosting language features to modify the parse tree. Seemingly clumsy, code transformations will be further improved once pattern matching is implemented in the language.</li><li>It uses regexps for convenience.</li><li>It doesn't look anything like PEG's - dropping operator precedence simplifies the generator greatly. It's quite ironic, since this reader facility will most likely be used to introduce operator precedence and complex syntax rules to ASM DSLs. The correspondence of ASM reader syntax to PEG syntax is represented on the following snippet:</li></ul><p><div class="row"><div class="col-xs-12 col-md-8 col-md-offset-2 col-lg-6 col-lg-offset-3"></p><pre><code class="yaml">sequence:        &#40;A B C ...&#41;   =&gt; A B C ...
ordered choice:  &#40;/ A B C ...&#41; =&gt; A / B / C / ...
optional branch: &#40;? ...&#41;     =&gt; &#40;...&#41;?
zero or more:    &#40;&#42; ...&#41;     =&gt; &#40;...&#41;&#42;
one or more:     &#40;+ ...&#41;     =&gt; &#40;...&#41;+
not:             &#40;! ...&#41;     =&gt; !&#40;...&#41;
and &#40;lookahead&#41;: &#40;&amp; ...&#41;     =&gt; &amp;&#40;...&#41;

drop node:       &#40;: ...&#41;     -  Drops a node from the parse tree.
concat captures: &#40;&#126; ...&#41;     -  Concatenates captures.
</code></pre><p></div></div></p><h2><a name="grammar-macros"></a><a href="#grammar-macros">Grammar macros</a></h2>As stated above, the reader is extensible and defining new grammar rules is very straightforward:<p><div class="row"><div class="col-xs-12 col-md-8 col-md-offset-2 col-lg-6 col-lg-offset-3"></p><pre><code class="scheme">&#40;syntax &#40;Lambda &lt; List &#40;: &quot;-&gt;&quot;&#41; Expression&#41;
  `&#40;$&#40;car Lambda&#41;
    &#40;&#40;lambda $&#40;caadr Lambda&#41; $&#40;cadadr Lambda&#41;&#41;&#41;&#41;&#41;

&#40;syntax &#40;Expression &lt; &#40;/ Lambda String List Atom&#41;&#41;&#41;

&#40;Expression &quot;&#40;map &#40;x&#41; -&gt; &#40;&#42; x x&#41;
                  &#40;list 1 2 3 4 5&#41;&#41;&quot;&#41;
</code></pre><p></div></div></p><p>It also explicitly states the interaction of a new macro with the rest of the grammar making it safe to use and easy to debug.</p><p>Here's another example, that extends ASM grammar to support direct manipulation of JSON objects:</p><p><div class="row"><div class="col-xs-12 col-md-8 col-md-offset-2 col-lg-6 col-lg-offset-3"></p><pre><code class="scheme">&#40;grammar &#40;&#40;JValue  &lt; &#40;/ String Number JObject
                        JArray JTrue JFalse JNull&#41;&#41;&#41;
         &#40;&#40;JObject &lt; &#40;: &quot;\\{&quot;&#41; &#40;? JPair &#40;&#42; &#40;:&quot;,&quot;&#41; JPair&#41;&#41; &#40;:&quot;\\}&quot;&#41;&#41;
           `&#40;$&#40;car JObject&#41;
             &#40;$&#40;cons 'scope &#40;cadr JObject&#41;&#41;&#41;&#41;&#41;
         &#40;&#40;JPair   &lt; String &#40;: &quot;:&quot;&#41; JValue&#41;
           `&#40;$&#40;car JPair&#41;
             &#40;&#40;var $&#40;str-&gt;symbol &#40;caadr JPair&#41;&#41; $&#40;cadadr JPair&#41;&#41;&#41;&#41;&#41;
         &#40;&#40;JArray  &lt; &#40;:&quot;\\​&#91;&quot;&#41; &#40;? JValue &#40;&#42; &#40;:&quot;,&quot;&#41; JValue&#41;&#41; &#40;:&quot;\\&#93;&quot;&#41;&#41;
           `&#40;$&#40;car JArray&#41;
             &#40;$&#40;vectorof &#40;cadr JArray&#41;&#41;&#41;&#41;&#41;
         &#40;&#40;JTrue   &lt;- &#40;: &quot;true&quot;&#41;&#41;
           `&#40;$&#40;car JTrue&#41;
             &#40;'t&#41;&#41;&#41;
         &#40;&#40;JFalse  &lt;- &#40;: &quot;false&quot;&#41;&#41;&#41;
         &#40;&#40;JNull   &lt;- &#40;: &quot;null&quot;&#41;&#41;&#41;&#41;

&#40;syntax &#40;Expression &lt; &#40;/ Quote JObject String List Atom&#41;&#41;&#41;
</code></pre><p></div></div></p><p>And after running the experimental <code>REPL</code> by invoking <code>&#40;repl&#41;</code> you can use it like this:</p><p><div class="row"><div class="col-xs-12 col-md-8 col-md-offset-2 col-lg-6 col-lg-offset-3"></p><pre><code class="js">&#40;var json { &quot;number&quot;: 1234.567,
            &quot;string&quot;: &quot;abcd&quot;,
            &quot;object&quot;: { &quot;member0&quot;: &quot;value&quot;,
                        &quot;member1&quot;: &quot;value&quot; },
            &quot;boolean&quot;: true,
            &quot;null&quot;: null }&#41;

&#40;set! &#40;json number&#41; 9876.543&#41;
</code></pre><p></div></div></p><p>Neat, isn't it?</p><h2><a name="reader_-writer...-compiler_"></a><a href="#reader_-writer...-compiler_">Reader, writer... Compiler?</a></h2>There's much space for improvement in the design and at the moment I'm trying to come up with a simple and natural way to sew ASM writer (facility responsible for printing ASM code) together with the reader. Ideally defining one grammar will be enough to generate both the reader and a complimentary writer, however custom writers will be possible facilitating language-to-language translation.For example, ASM' bytecode compiler might be implemented in terms of such a writer. Ahhh, the <a href='http://i717.photobucket.com/albums/ww176/archer_myka/1-line-of-symmetry.png'>delicious symmetry</a>.<p>Most likely pattern matching and some form of <a href='http://erights.org/elib/capability/ode/ode-capabilities.html'>sealer/unsealer</a> pattern will be used to achieve this.</p><p><hr /> <div style="font-size: x-small;"></p><p><del>I've recently started using <a href='https://github.com/punchagan/org2blog'>Org2Blog</a> to manage this blog and it turned out to be such an awesome tool that I feel obliged to mention it here. So there's that.</del></p><p></div></p><p><strong>2016-02-16</strong>: Not true anymore, also adjusted some links & tags.</p><footer><div class="row"><div class="hidden-xs col-md-2"></div><div class="col-xs-6 col-md-4"><nav><ul class="pager"><li class="previous"><a href="../entries/there-is-nothing-cooler-than-a-macr--err...-mixin_.html"><i class="fa fa-chevron-left" style="margin-right: 5px;"></i><span class="entry-title">There is nothing cooler than a macr- Err... Mixin?</span></a></li></ul></nav></div><div class="col-xs-6 col-md-4"><nav><ul class="pager"><li class="next"><a href="../entries/system-monitor-in-emacs-mode-line.html"><span class="entry-title">System monitor in Emacs mode-line</span><i class="fa fa-chevron-right" style="margin-left: 5px;"></i></a></li></ul></nav></div></div></footer></article><footer><hr /><div class="row"><div class="text-center"><div class="row"><div>Copyright © 2011-2016 Kajetan "Kajtek" Rzepecki</div><div>All writing licensed under <a href="http://creativecommons.org/licenses/by-sa/4.0/" rel="license">CC BY-SA 4.0</a>. All code released under the <a href="../media/LICENSE" rel="license">MIT license</a> unless otherwise specified.</div></div></div><div class="text-center"><p>Powered by <a href="https://github.com/Idorobots/lambda-blog">λ-blog</a>.</p></div></div></footer></div></article></div></body></html>