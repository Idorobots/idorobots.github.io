<!DOCTYPE html><html><head><meta charset="utf-8" /><title>MochiWeb vs. Cowboy, HTTP vs. WebSocket benchmark</title><link href="../style/bootstrap.min.css" rel="stylesheet" type="text/css" /><link href="../style/font-awesome.min.css" rel="stylesheet" type="text/css" /><link href="../style/ts.theme.dark.css" rel="stylesheet" type="text/css" /><link href="../style/hljs.theme.hybrid.css" rel="stylesheet" type="text/css" /><link href="../style/blog.css" rel="stylesheet" type="text/css" /><link href="../index.xml" rel="alternate" title="MochiWeb vs. Cowboy, HTTP vs. WebSocket benchmark Feed" type /><link href="../media/favicon.ico" rel="icon" type="image/png" /><script src="../js/jquery-2.2.0.min.js" type="text/javascript"></script><script src="../js/jquery.tablesorter.min.js" type="text/javascript"></script><script src="../js/bootstrap.min.js" type="text/javascript"></script><script src="../js/highlight.min.js" type="text/javascript"></script><script src="../js/blog.js" type="text/javascript"></script><meta content="width=device-width, initial-scale=1.0" name="viewport" /><meta content="λ-blog v.1.3.2" name="generator" /><meta content="Idorobots" name="author" /><meta content="Kajetan Rzepecki, Idorobots, dev-blog, devblog, blog, Clojure, Lisp, Erlang, technology, electronics, hacks, computer science" name="keywords" /><meta content="Yes Mom, I *do* robots." name="description" /></head><body><nav class="navbar navbar-default navbar-fixed-top"><div class="container"><div class="navbar-header"><button class="navbar-toggle navbar-brand pull-left" data-target="#navbar-responsive-collapse" data-toggle="collapse" type="button"><div><img src="../media/logo.svg" />idorobots.org</div></button><div class="hidden-xs"><a class="navbar-brand" href=".."><div><img src="../media/logo.svg" />idorobots.org</div></a></div></div><div class="collapse navbar-collapse navbar-right" id="navbar-responsive-collapse"><ul class="nav navbar-nav"><li><a href="https://github.com/Idorobots"><i class="fa fa-github"></i> GitHub</a></li><li><a href="../resume.html"><i class="fa fa-trophy"></i> Resumé</a></li><li><a href="../contact.html"><i class="fa fa-comment"></i> Contact</a></li><li class="divider hidden-sm hidden-md hidden-lg"></li><li class="hidden-sm hidden-md hidden-lg"><a href=".."><i class="fa fa-home"></i> Home</a></li><li class="hidden-sm hidden-md hidden-lg"><a href="../archives.html"><i class="fa fa-archive"></i> Archives</a></li><li class="hidden-sm hidden-md hidden-lg"><a href="../tags/index.html"><i class="fa fa-tags"></i> Tag Cloud</a></li><li class="hidden-sm hidden-md hidden-lg"><a href="../index.xml"><i class="fa fa-feed"></i> Feed</a></li><li class="dropdown hidden-xs"><a href="#"><i class="fa fa-chevron-right"></i></a><ul class="dropdown-menu"><li><a href=".."><i class="fa fa-home"></i> Home</a></li><li><a href="../archives.html"><i class="fa fa-archive"></i> Archives</a></li><li><a href="../tags/index.html"><i class="fa fa-tags"></i> Tag Cloud</a></li><li><a href="../index.xml"><i class="fa fa-feed"></i> Feed</a></li></ul></li></ul></div></div></nav><div class="body-wrap"><article id="page"><div class="container"><header class="page-header"></header><article><header><div class="panel panel-default"><div class="panel-body"><div class="text-center"><h1>MochiWeb vs. Cowboy, HTTP vs. WebSocket benchmark</h1><p>Posted on <time>2013-06-01 22:55</time> by <a href="https://github.com/Idorobots">Idorobots</a></p><nav><a class="tag" href="../tags/comet.html"><span class="label label-info small">Comet</span></a> <a class="tag" href="../tags/cowboy.html"><span class="label label-info small">Cowboy</span></a> <a class="tag" href="../tags/erlang.html"><span class="label label-info small">Erlang</span></a> <a class="tag" href="../tags/http.html"><span class="label label-info small">HTTP</span></a> <a class="tag" href="../tags/mochiweb.html"><span class="label label-info small">MochiWeb</span></a> <a class="tag" href="../tags/otp.html"><span class="label label-info small">OTP</span></a> <a class="tag" href="../tags/websocket.html"><span class="label label-info small">WebSocket</span></a> <a class="tag" href="../tags/benchmarks.html"><span class="label label-info small">benchmarks</span></a></nav></div></div></div></header><p>Lately I've been <a href='http://erlang.org/pipermail/erlang-questions/2004-April/011998.html'>banging around</a> a lot in order to get up to speed with <strong>Erlang/OTP</strong> and its various web-server libraries, and I figured I could share some of my findings here for future reference and in general for <em>The Greater Good</em>.</p><h2><a name="test-server"></a><a href="#test-server">Test server</a></h2><p>As you might have already noticed, this benchmark concerns two of the most well knows Erlang web-server libraries, <a href='https://github.com/mochi/mochiweb'>MochiWeb</a> and <a href='https://github.com/extend/cowboy'>Cowboy</a>, and it aims to explore their behaviour under <a href='#setup'>some considerable load</a>.</p><p>The <a href='https://github.com/Idorobots/brain-server'>server in question</a> uses two communication protocols, <strong>HTTP</strong> and <strong>WebSocket</strong>, so as an added benefit we'll see how these two compare. Unfortunately, MochiWeb doesn't have a built-in support for WebSocket, so <a href='https://github.com/Idorobots/brain-server/blob/master/src/mochiweb_websocket.erl'>an external library</a> was needed. The rather simple client API is defined as:</p><ul><li><strong>ht​tp://host/poll/N</strong> - an HTTP chunked reply with one chunk of data sent every <em>N</em> seconds,</li><li><strong>ws://host/wspoll/N</strong> - a WebSocket connection with one chunk sent every <em>N</em> seconds.<a name="preview-more"></a></li></ul><h2><a name="setup"></a><a href="#setup">Setup</a></h2><p>The testing side consists of a <a href='https://github.com/Idorobots/flood/tree/6db95133a77782e1953a1f14d1c98d0ef7ff3de0'>load simulator</a>, that spawns and maintains a bajilion simultaneous connections restarting them if need be, and a <a href='https://github.com/Idorobots/brain-monitor'>monitor</a> that collects vital server data. Naturally, to minimize simulators impact on the servers performance it was running on a separate machine. The overall setup looked like this:</p><p><img src="http://blog.idorobots.org/media/mochicowboy/brain.png" alt="brain" /></p><p>For either back-end and communication protocol (so four runs in total) the simulator was ordered to incrementally spawn 1000 additional connections every several minutes, each of which issued a <code>/&#40;ws&#41;poll/1/</code> request and waited for the reply chunks restarting in case of a failure.</p><p>On the other side, the monitor focused on collecting Erlang VMs data, such as <em>total memory usage</em>, <em>SMP utilization</em> or <em>IO operations</em>, over 5 minute periods excluding the "boot-up time" of each new batch of connections and the "dump time" of dumping the benchmark data into a file.</p><p>Each test was continued until 10000 simultaneous connections have been reached, mainly because I don't hate my machines THAT much... The most interesting results are plotted below with some <a href='#conclusion'>subjective commentary</a> following...</p><h2><a name="results"></a><a href="#results">Results</a></h2>Total memory usage registered for the <strong>Cowboy</strong> back-end as a function of the number of simultaneous connections (I also included the maximal values for each data set as this might give you an idea of the <a href='http://en.wikipedia.org/wiki/Garbage_collection_(computer_science'>GC</a>) behaviour):<p><img src="http://blog.idorobots.org/media/mochicowboy/cowboy_memory.png" alt="cowboy_memory" /></p><p>Average (blue line) and maximal (red, dashed line) SMP utilization  of the <strong>Cowboy</strong> back-end (corresponds directly to the CPU utilization of the underlying machine):</p><p><img src="http://blog.idorobots.org/media/mochicowboy/cowboy_smp.png" alt="cowboy_smp" /></p><p>Total memory usage of the <strong>MochiWeb</strong> back-end as a function of the number of simultaneous connections:</p><p><img src="http://blog.idorobots.org/media/mochicowboy/mochiweb_memory.png" alt="mochiweb_memory" /></p><p>Average (blue) and maximal (red) SMP utilization of the <strong>MochiWeb</strong> back-end:</p><p><img src="http://blog.idorobots.org/media/mochicowboy/mochiweb_smp.png" alt="mochiweb_smp" /></p><p>Total memory usage comparison of the back-ends:</p><p><img src="http://blog.idorobots.org/media/mochicowboy/comp_memory.png" alt="comp_memory" /></p><p>Average SMP utilization comparison of the back-ends:</p><p><img src="http://blog.idorobots.org/media/mochicowboy/comp_smp.png" alt="comp_smp" /></p><h2><a name="conclusion"></a><a href="#conclusion">Conclusion</a></h2>It's easy to see that the Cowboy back-end is a bit more CPU-heavy. This is partially due to the fact that the test-server implementation hibernates heavily in order to preserve memory.<p>Another interesting thing is the huge memory advantage of Cowboy/WebSocket over MochiWeb, <strong>25%</strong> difference for ten thousand connections is a pretty big deal.</p><p>One odd behaviour of the Cowboy/HTTP back-end is the way it scales its memory usage with the number of connections, I expected something similar to MochiWeb/HTTP, that is linear relation, but it turns out to be a bit more complex.</p><p>One curious thing about both of the back-ends (or possibly about my network), which I did not include above, was the error rate which I estimate at <strong>1-4%</strong>. It was hard to measure, as the load simulator auto-magically restarts broken connections, but it was definitely a thing and I might want to investigate this some more in the future.</p><p>I did not include the <em>context switches</em> or <em>IO</em> data in this posts either, as these turned out to be, unsurprisingly (or perhaps surprisingly, I can't really decide), pretty similar for both back-ends and protocols.</p><p>Lastly, I'd love to repeat this benchmark on even bigger number of connections, as I have a feeling that that's where Cowboy really excels, but I need to beef up my hardware first...</p><p><strong>2013-09-05</strong>: Updated with some GitHub links.</p><p><strong>2016-02-05</strong>: Adjusted some links.</p><footer><div class="row"><div class="hidden-xs col-md-2"></div><div class="col-xs-6 col-md-4"><nav><ul class="pager"><li class="previous"><a href="../entries/google-reader-alternative-for-emacs-ninjas.html"><i class="fa fa-chevron-left" style="margin-right: 5px;"></i><span class="entry-title">Google Reader alternative for Emacs Ninjas</span></a></li></ul></nav></div><div class="col-xs-6 col-md-4"><nav><ul class="pager"><li class="next"><a href="../entries/blog-reboot_.html"><span class="entry-title">Blog reboot!</span><i class="fa fa-chevron-right" style="margin-left: 5px;"></i></a></li></ul></nav></div></div></footer></article><footer><hr /><div class="row"><div class="text-center"><div class="row"><div>Copyright © 2011-2016 Kajetan "Kajtek" Rzepecki</div><div>All writing licensed under <a href="http://creativecommons.org/licenses/by-sa/4.0/" rel="license">CC BY-SA 4.0</a>. All code released under the <a href="../media/LICENSE" rel="license">MIT license</a> unless otherwise specified.</div></div></div><div class="text-center"><p>Powered by <a href="https://github.com/Idorobots/lambda-blog">λ-blog</a>.</p></div></div></footer></div></article></div></body></html>